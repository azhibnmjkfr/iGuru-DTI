<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>Rekap Nilai - iGuru-DTI</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%230a2540'/><text x='50' y='70' font-size='70' text-anchor='middle' fill='%23b68b40' font-family='Arial' font-weight='bold'>iG</text></svg>">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #1e293b; line-height: 1.5; min-height: 100vh; display: flex; flex-direction: column; }
        :root { --navy: #0a2540; --slate: #5f6b7a; --gold: #b68b40; --light: #f1f5f9; --white: #ffffff; --dark: #1e293b; --shadow: 0 10px 30px -10px rgba(0,0,0,0.15); }
        
        .container { max-width: 1280px; margin: 0 auto; padding: 1.5rem; width: 100%; flex: 1; position: relative; }
        
        /* HEADER */
        .header {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            background: var(--white);
            padding: 1.2rem 2rem;
            border-radius: 50px;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }
        .back-btn {
            background: var(--navy);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            text-decoration: none;
            transition: 0.2s;
        }
        .back-btn:hover { background: #1d3a5c; transform: translateX(-3px); }
        .title { font-size: 1.8rem; color: var(--navy); font-weight: 600; }
        .title span { color: var(--gold); font-size: 1rem; background: #f1f5f9; padding: 0.3rem 1rem; border-radius: 40px; margin-left: 1rem; }
        
        /* INFO CARD PREMIUM */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .info-card-premium {
            background: white;
            border-radius: 30px;
            padding: 1.5rem 1rem;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            transition: 0.3s;
        }
        .info-card-premium:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }
        .info-icon-large {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        .info-card-premium h4 {
            color: var(--slate);
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 0.3rem;
        }
        .info-card-premium p {
            color: var(--navy);
            font-size: 1.8rem;
            font-weight: 700;
            line-height: 1.2;
        }
        .info-card-premium small {
            color: var(--gold);
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        /* FILTER */
        .filter-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 0.8rem;
            background: rgba(255,255,255,0.9);
            padding: 1.2rem;
            border-radius: 40px;
            margin-bottom: 1.5rem;
            align-items: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
        }
        .filter-input, .filter-select {
            padding: 0.8rem 1.2rem;
            border: 2px solid #e2e8f0;
            border-radius: 40px;
            font-size: 0.95rem;
            background: white;
            flex: 1 1 200px;
        }
        .filter-input:focus, .filter-select:focus { border-color: var(--gold); outline: none; }
        .filter-btn {
            background: var(--navy);
            color: white;
            border: none;
            padding: 0.8rem 2rem;
            border-radius: 40px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
        }
        .filter-btn:hover { background: #1d3a5c; transform: scale(1.02); }
        .reset-btn {
            background: #e2e8f0;
            color: var(--dark);
            border: none;
            padding: 0.8rem 2rem;
            border-radius: 40px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
        }
        .reset-btn:hover { background: #cbd5e1; }
        
        /* TABLE PREMIUM */
        .table-container {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
            border-radius: 30px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
            position: relative;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
            font-size: 0.9rem;
        }
        th {
            background: var(--navy);
            color: white;
            padding: 1rem 0.8rem;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
            font-weight: 600;
        }
        td {
            padding: 1rem 0.8rem;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            white-space: nowrap;
            text-align: center;
        }
        td:first-child, th:first-child { text-align: left; }
        td:nth-child(2), th:nth-child(2) { text-align: left; }
        tbody tr:nth-child(even) { background: rgba(241, 245, 249, 0.5); }
        tbody tr:hover { background: rgba(182, 139, 64, 0.1); }
        
        /* NILAI HIGHLIGHT */
        .nilai-bagus { color: #27ae60; font-weight: 600; }
        .nilai-cukup { color: #f39c12; font-weight: 600; }
        .nilai-kurang { color: #e74c3c; font-weight: 600; }
        
        /* KETERANGAN BADGE */
        .badge-lulus {
            display: inline-block;
            padding: 0.3rem 1rem;
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border-radius: 40px;
            font-size: 0.8rem;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(39, 174, 96, 0.3);
        }
        
        /* BACK TO TOP BUTTON */
        #backToTop {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--navy);
            color: white;
            width: 55px;
            height: 55px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
            border: none;
            box-shadow: var(--shadow);
            opacity: 0;
            visibility: hidden;
            transition: 0.3s;
            z-index: 100;
        }
        #backToTop.show {
            opacity: 1;
            visibility: visible;
        }
        #backToTop:hover {
            background: #1d3a5c;
            transform: translateY(-3px);
        }
        
        @media (max-width: 768px) {
            .info-grid { grid-template-columns: repeat(2, 1fr); }
            .container { padding: 1rem; }
            .header { flex-direction: column; text-align: center; }
            .title span { display: block; margin: 0.5rem 0 0; }
            .filter-bar { flex-direction: column; }
            .filter-btn, .reset-btn { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <a href="../guru/azh12345.html?tab=nilai" class="back-btn">‚Üê</a>
            <div class="title">
                üìä Rekap Nilai
            </div>
        </div>

        <!-- INFO CARD PREMIUM -->
        <div class="info-grid" id="infoGrid">
            <div class="info-card-premium">
                <div class="info-icon-large">üìö</div>
                <h4>Total Siswa</h4>
                <p id="totalSiswa">-</p>
                <small>semua kelas</small>
            </div>
            <div class="info-card-premium">
                <div class="info-icon-large">üìä</div>
                <h4>Rata-rata</h4>
                <p id="rataRapor">-</p>
                <small>nilai rapor</small>
            </div>
            <div class="info-card-premium">
                <div class="info-icon-large">üèÜ</div>
                <h4>Tertinggi</h4>
                <p id="nilaiTertinggi">-</p>
                <small id="siswaTertinggi">-</small>
            </div>
            <div class="info-card-premium">
                <div class="info-icon-large">üìâ</div>
                <h4>Terendah</h4>
                <p id="nilaiTerendah">-</p>
                <small id="siswaTerendah">-</small>
            </div>
            <div class="info-card-premium">
                <div class="info-icon-large">‚úÖ</div>
                <h4>Lulus</h4>
                <p id="totalLulus">-</p>
                <small>100% lulus</small>
            </div>
        </div>

        <!-- FILTER -->
        <div class="filter-bar">
            <input type="text" class="filter-input" id="searchNama" placeholder="Cari nama siswa...">
            <select class="filter-select" id="filterKelas">
                <option value="all">Semua Kelas</option>
                <option value="8A">8A</option>
                <option value="9A">9A</option>
                <option value="9B">9B</option>
                <option value="9C">9C</option>
                <option value="9D">9D</option>
            </select>
            <select class="filter-select" id="sortBy">
                <option value="none">Urutkan</option>
                <option value="nameAsc">Nama A-Z</option>
                <option value="nameDesc">Nama Z-A</option>
                <option value="raporDesc">Nilai Tertinggi</option>
                <option value="raporAsc">Nilai Terendah</option>
            </select>
            <button class="filter-btn" id="applyFilter">Terapkan</button>
            <button class="reset-btn" id="resetFilter">Reset</button>
        </div>

        <!-- TABLE CONTAINER -->
        <div class="table-container" id="tableContainer">
            <table id="rekapTable">
                <thead id="tableHeader"></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>

        <!-- BACK TO TOP BUTTON -->
        <button id="backToTop" title="Kembali ke atas">‚Üë</button>
    </div>

    <script>
        // KONFIGURASI
        const SPREADSHEET_ID = '1YlGB2Kiu0BOtWjRXgm7NwcQgxO6K9crzPXuevcasvjc';
        const SHEET_NAME = 'Rekap_Nilai';
        const URL = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:csv&sheet=${SHEET_NAME}`;

        let originalData = { headers: [], rows: [] };
        let currentData = { headers: [], rows: [] };

        // ==================== FETCH DATA ====================
        async function fetchData() {
            try {
                const response = await fetch(URL);
                const csvText = await response.text();
                parseData(csvText);
            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('tableBody').innerHTML = '<tr><td colspan="9" style="text-align:center; padding:2rem;">‚ú® Gagal memuat data. Periksa koneksi atau coba lagi.</td></tr>';
            }
        }

        function parseData(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length < 2) {
                document.getElementById('tableBody').innerHTML = '<tr><td colspan="9" style="text-align:center;">üì≠ Data tidak ditemukan</td></tr>';
                return;
            }

            // Header (baris 1)
            const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
            
            // Data mulai baris 2
            const dataRows = lines.slice(1).map(line => {
                return line.split(',').map(cell => cell.replace(/"/g, '').trim());
            });

            originalData = { headers, rows: dataRows };
            currentData = { headers: [...headers], rows: [...dataRows] };
            
            renderTable();
            updateInfo();
        }

        // ==================== RENDER TABLE ====================
        function renderTable() {
            const thead = document.getElementById('tableHeader');
            const tbody = document.getElementById('tableBody');
            
            if (!currentData.rows.length) {
                thead.innerHTML = '<tr><th>Data tidak tersedia</th></tr>';
                tbody.innerHTML = '';
                return;
            }

            // Header
            thead.innerHTML = '<tr>' + currentData.headers.map(h => `<th>${h}</th>`).join('') + '</tr>';

            // Body dengan highlight nilai
            tbody.innerHTML = currentData.rows.map(row => {
                const nilaiRapor = parseFloat(row[7]) || 0;
                let nilaiClass = '';
                if (nilaiRapor >= 86) nilaiClass = 'nilai-bagus';
                else if (nilaiRapor >= 75) nilaiClass = 'nilai-cukup';
                else nilaiClass = 'nilai-kurang';
                
                return '<tr>' + row.map((cell, idx) => {
                    if (cell === '' || cell === null) return '<td>-</td>';
                    
                    // Kolom NILAI_RAPOR (index 7) - beri warna
                    if (idx === 7) {
                        return `<td class="${nilaiClass}"><strong>${cell}</strong></td>`;
                    }
                    // Kolom KETERANGAN (index 8) - badge lulus
                    if (idx === 8 && cell === 'LULUS') {
                        return `<td><span class="badge-lulus">${cell}</span></td>`;
                    }
                    return `<td>${cell}</td>`;
                }).join('') + '</tr>';
            }).join('');
        }

        // ==================== UPDATE INFO ====================
        function updateInfo() {
            const total = currentData.rows.length;
            document.getElementById('totalSiswa').innerText = total;
            
            // Hitung statistik
            const nilaiIndex = 7; // NILAI_RAPOR di index 7
            const namaIndex = 1; // NAMA_SISWA di index 1
            
            let totalNilai = 0;
            let countNilai = 0;
            let nilaiTertinggi = -Infinity;
            let nilaiTerendah = Infinity;
            let siswaTertinggi = '';
            let siswaTerendah = '';
            
            currentData.rows.forEach(row => {
                const nilai = parseFloat(row[nilaiIndex]);
                if (!isNaN(nilai)) {
                    totalNilai += nilai;
                    countNilai++;
                    
                    if (nilai > nilaiTertinggi) {
                        nilaiTertinggi = nilai;
                        siswaTertinggi = row[namaIndex];
                    }
                    if (nilai < nilaiTerendah) {
                        nilaiTerendah = nilai;
                        siswaTerendah = row[namaIndex];
                    }
                }
            });
            
            const avg = countNilai > 0 ? (totalNilai / countNilai).toFixed(2) : '-';
            document.getElementById('rataRapor').innerText = avg;
            
            if (nilaiTertinggi > -Infinity) {
                document.getElementById('nilaiTertinggi').innerText = nilaiTertinggi;
                document.getElementById('siswaTertinggi').innerText = siswaTertinggi.substring(0, 15) + (siswaTertinggi.length > 15 ? '...' : '');
            }
            
            if (nilaiTerendah < Infinity) {
                document.getElementById('nilaiTerendah').innerText = nilaiTerendah;
                document.getElementById('siswaTerendah').innerText = siswaTerendah.substring(0, 15) + (siswaTerendah.length > 15 ? '...' : '');
            }
            
            document.getElementById('totalLulus').innerText = total;
        }

        // ==================== FILTER & SORT ====================
        function applyFilter() {
            const search = document.getElementById('searchNama').value.toLowerCase();
            const kelas = document.getElementById('filterKelas').value;
            const sort = document.getElementById('sortBy').value;
            
            const namaIndex = 1; // NAMA_SISWA di index 1
            const kelasIndex = 2; // KELAS di index 2
            const nilaiIndex = 7; // NILAI_RAPOR di index 7
            
            let filtered = originalData.rows.filter(row => {
                const matchNama = !search || (row[namaIndex] && row[namaIndex].toLowerCase().includes(search));
                const matchKelas = kelas === 'all' || row[kelasIndex] === kelas;
                return matchNama && matchKelas;
            });
            
            // Sorting
            if (sort === 'nameAsc') {
                filtered.sort((a, b) => (a[namaIndex] || '').localeCompare(b[namaIndex] || ''));
            } else if (sort === 'nameDesc') {
                filtered.sort((a, b) => (b[namaIndex] || '').localeCompare(a[namaIndex] || ''));
            } else if (sort === 'raporDesc') {
                filtered.sort((a, b) => (parseFloat(b[nilaiIndex]) || 0) - (parseFloat(a[nilaiIndex]) || 0));
            } else if (sort === 'raporAsc') {
                filtered.sort((a, b) => (parseFloat(a[nilaiIndex]) || 0) - (parseFloat(b[nilaiIndex]) || 0));
            }
            
            currentData.rows = filtered;
            renderTable();
            updateInfo();
        }

        function resetFilter() {
            document.getElementById('searchNama').value = '';
            document.getElementById('filterKelas').value = 'all';
            document.getElementById('sortBy').value = 'none';
            currentData.rows = [...originalData.rows];
            renderTable();
            updateInfo();
        }

        // ==================== BACK TO TOP ====================
        const backToTopBtn = document.getElementById('backToTop');
        const tableContainer = document.getElementById('tableContainer');

        tableContainer.addEventListener('scroll', () => {
            if (tableContainer.scrollTop > 300) {
                backToTopBtn.classList.add('show');
            } else {
                backToTopBtn.classList.remove('show');
            }
        });

        backToTopBtn.addEventListener('click', () => {
            tableContainer.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // ==================== INIT ====================
        document.getElementById('applyFilter').addEventListener('click', applyFilter);
        document.getElementById('resetFilter').addEventListener('click', resetFilter);
        
        // Load data
        fetchData();

        // Handle tab parameter dari URL
        const urlParams = new URLSearchParams(window.location.search);
        const tab = urlParams.get('tab') || 'nilai';
        document.querySelector('.back-btn').href = `../guru/azh12345.html?tab=${tab}`;
    </script>
</body>
</html>