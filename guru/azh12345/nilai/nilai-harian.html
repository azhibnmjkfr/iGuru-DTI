<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover">
    <title>Nilai Harian - iGuru-DTI</title>
    <meta name="description" content="Data nilai harian siswa - Bahasa Inggris MTsT Daarut Tahfizh Al-Ikhlas">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%230a2540'/><text x='50' y='70' font-size='70' text-anchor='middle' fill='%23b68b40' font-family='Arial' font-weight='bold'>iG</text></svg>">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { 
            background: linear-gradient(135deg, #f1f5f9 0%, #e9eef3 100%);
            color: #1e293b; 
            line-height: 1.5; 
            min-height: 100vh; 
            display: flex; 
            flex-direction: column; 
        }
        :root { 
            --navy: #0a2540; 
            --slate: #5f6b7a; 
            --gold: #b68b40; 
            --light: #f1f5f9; 
            --white: #ffffff; 
            --dark: #1e293b; 
            --shadow: 0 10px 30px -10px rgba(0,0,0,0.15);
            --shadow-hover: 0 20px 40px -15px rgba(10,37,64,0.25);
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }
        html { scroll-behavior: smooth; }
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            padding: 1.5rem; 
            width: 100%; 
            flex: 1; 
        }
        
        /* HEADER */
        .header {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            background: var(--white);
            padding: 1.2rem 2rem;
            border-radius: 60px;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            flex-wrap: wrap;
            border: 1px solid rgba(255,255,255,0.5);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--gold), var(--navy));
        }
        .back-btn {
            background: var(--navy);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            text-decoration: none;
            transition: 0.3s ease;
            border: none;
            cursor: pointer;
            flex-shrink: 0;
        }
        .back-btn:hover { 
            background: #1d3a5c; 
            transform: translateX(-5px) scale(1.05);
            box-shadow: 0 8px 20px rgba(10,37,64,0.3);
        }
        .back-btn i { transition: transform 0.3s ease; }
        .back-btn:hover i { transform: translateX(-3px); }
        
        .title { 
            font-size: 2rem; 
            color: var(--navy); 
            font-weight: 700;
            background: linear-gradient(135deg, var(--navy), #1d3a5c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
        .title i { 
            color: var(--gold);
            -webkit-text-fill-color: initial;
            font-size: 2.2rem;
        }
        .title span { 
            color: var(--slate); 
            font-size: 0.9rem; 
            background: #f1f5f9; 
            padding: 0.3rem 1rem; 
            border-radius: 40px; 
            margin-left: 1rem;
            -webkit-text-fill-color: initial;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }
        
        /* INFO CARD */
        .info-card {
            background: var(--white);
            border-radius: 40px;
            padding: 1.8rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            display: flex;
            flex-wrap: wrap;
            gap: 2rem;
            align-items: center;
            border: 1px solid rgba(255,255,255,0.5);
            position: relative;
            overflow: hidden;
        }
        .info-card::after {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            width: 200px;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(182, 139, 64, 0.05));
            pointer-events: none;
        }
        .info-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex: 1 1 200px;
            transition: all 0.3s ease;
        }
        .info-item:hover { transform: translateY(-3px); }
        .info-icon {
            background: linear-gradient(135deg, var(--navy), #1d3a5c);
            color: white;
            width: 55px;
            height: 55px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 8px 15px -5px rgba(10,37,64,0.2);
            border: 2px solid var(--gold);
        }
        .info-text h4 { 
            font-size: 0.85rem; 
            color: var(--slate); 
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .info-text p { 
            font-size: 1.6rem; 
            color: var(--navy); 
            font-weight: 700;
            line-height: 1.2;
        }
        
        /* FILTER BAR */
        .filter-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 0.8rem;
            background: var(--white);
            padding: 1.2rem;
            border-radius: 50px;
            margin-bottom: 2rem;
            align-items: center;
            box-shadow: var(--shadow);
            border: 2px solid #e9eef3;
        }
        .filter-input, .filter-select {
            padding: 0.9rem 1.2rem;
            border: 2px solid #e2e8f0;
            border-radius: 50px;
            font-size: 16px;
            background: white;
            flex: 1 1 200px;
            transition: all 0.3s ease;
        }
        .filter-input:focus, .filter-select:focus { 
            border-color: var(--gold); 
            outline: none;
            box-shadow: 0 0 0 4px rgba(182, 139, 64, 0.1);
            transform: translateY(-2px);
        }
        .filter-input:hover, .filter-select:hover { border-color: var(--navy); }
        .filter-btn, .reset-btn {
            padding: 0.9rem 2rem;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
        }
        .filter-btn {
            background: var(--navy);
            color: white;
        }
        .filter-btn:hover { 
            background: #1d3a5c; 
            transform: translateY(-2px);
            box-shadow: 0 8px 15px -5px rgba(10,37,64,0.3);
        }
        .reset-btn {
            background: #e2e8f0;
            color: var(--dark);
        }
        .reset-btn:hover { 
            background: #cbd5e1; 
            transform: translateY(-2px);
        }
        
        /* TABLE CONTAINER - SMOOTH SCROLL */
        .table-container {
            overflow-x: auto;
            overflow-y: auto;
            max-height: 600px;
            border-radius: 30px;
            border: 2px solid #edf2f7;
            background: white;
            position: relative;
            scrollbar-width: thin;
            scrollbar-color: var(--gold) #e9eef3;
            -webkit-overflow-scrolling: touch;
            box-shadow: var(--shadow);
            scroll-behavior: smooth;
        }
        .table-container::-webkit-scrollbar { width: 10px; height: 10px; }
        .table-container::-webkit-scrollbar-track { background: #e9eef3; border-radius: 10px; }
        .table-container::-webkit-scrollbar-thumb { background: var(--gold); border-radius: 10px; transition: all 0.3s ease; }
        .table-container::-webkit-scrollbar-thumb:hover { background: var(--navy); }
        
        /* TABLE - HANYA KOLOM A SAMPAI M */
        table { 
            width: 100%; 
            border-collapse: separate; 
            border-spacing: 0; 
            min-width: 800px;
            font-size: 0.85rem;
        }
        
        /* JUMLAH KOLOM: 3 + (3 TOPIC x 3) + 1 = 13 KOLOM (A-M) */
        /* STICKY HEADER */
        thead {
            position: sticky;
            top: 0;
            z-index: 50;
            background: transparent;
        }
        
        /* MAIN HEADER */
        .main-header th {
            background: var(--navy);
            color: white;
            padding: 0.8rem 0.3rem;
            font-weight: 700;
            font-size: 0.85rem;
            text-align: center;
            white-space: nowrap;
            border-bottom: 3px solid var(--gold);
            position: relative;
        }
        .main-header th i { 
            margin-right: 0.2rem; 
            color: var(--gold);
            font-size: 0.8rem;
        }
        
        /* SUB HEADER */
        .sub-header th {
            background: var(--navy);
            color: rgba(255,255,255,0.95);
            padding: 0.5rem 0.2rem;
            font-weight: 500;
            font-size: 0.7rem;
            text-align: center;
            white-space: nowrap;
            border-bottom: 2px solid var(--gold);
            text-transform: uppercase;
            letter-spacing: 0.2px;
        }
        
        /* GROUP TOPIC */
        .topic-group th {
            border-left: 1px solid rgba(255,255,255,0.1);
            border-right: 1px solid rgba(255,255,255,0.1);
            background: var(--navy);
        }
        
        /* KOLOM NISN, NAMA, KELAS - STICKY KIRI */
        th:nth-child(1), th:nth-child(2), th:nth-child(3) { 
            background: var(--navy); 
            position: sticky;
            left: 0;
            z-index: 55;
            border-right: 2px solid var(--gold);
        }
        td:nth-child(1), td:nth-child(2), td:nth-child(3) { 
            position: sticky;
            left: 0;
            background: inherit;
            z-index: 10;
            border-right: 2px solid #e2e8f0;
        }
        td:nth-child(2) { left: 90px; } /* Lebar NISN */
        td:nth-child(3) { left: 200px; } /* NISN + Nama */
        th:nth-child(2) { left: 90px; z-index: 56; }
        th:nth-child(3) { left: 200px; z-index: 56; }
        
        /* KOLOM RATA-RATA (KOLOM 13) - STICKY KANAN */
        th:nth-child(13), td:nth-child(13) { 
            position: sticky;
            right: 0;
            z-index: 20;
        }
        th:nth-child(13) {
            background: var(--navy);
            border-left: 2px solid var(--gold);
        }
        td:nth-child(13) { 
            background: rgba(182, 139, 64, 0.1); 
            font-weight: 700; 
            color: var(--navy); 
            border-left: 2px solid var(--gold);
            box-shadow: -2px 0 5px rgba(0,0,0,0.05);
        }
        
        /* BODY TABLE */
        tbody tr { 
            cursor: pointer; 
            transition: background 0.2s ease; 
            background: white; 
        }
        tbody tr:nth-child(even) { background: #f8fafc; }
        tbody tr:hover { 
            background: linear-gradient(135deg, #e9eef3, #f8fafc); 
        }
        td { 
            padding: 0.7rem 0.3rem;
            border-bottom: 1px solid #e2e8f0; 
            white-space: nowrap; 
            text-align: center;
        }
        
        /* NILAI BULAT (TANPA KOMA) */
        .nilai-baik, .nilai-cukup, .nilai-kurang {
            font-weight: 700;
        }
        .nilai-baik { 
            color: #10b981; 
            background: rgba(16, 185, 129, 0.1);
        }
        .nilai-cukup { 
            color: #f59e0b; 
            background: rgba(245, 158, 11, 0.1);
        }
        .nilai-kurang { 
            color: #ef4444; 
            background: rgba(239, 68, 68, 0.1);
        }
        
        /* BADGE KELAS */
        .kelas-badge { 
            background: #e9eef3; 
            padding: 0.2rem 0.6rem; 
            border-radius: 50px; 
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--navy);
            display: inline-block;
        }
        
        /* BACK TO TOP */
        #backToTop {
            position: fixed;
            bottom: calc(2rem + var(--safe-bottom));
            right: 2rem;
            background: var(--navy);
            color: white;
            width: 55px;
            height: 55px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            cursor: pointer;
            border: none;
            box-shadow: var(--shadow-hover);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 100;
            border: 2px solid var(--gold);
        }
        #backToTop.show { opacity: 1; visibility: visible; }
        #backToTop:hover { 
            background: #1d3a5c; 
            transform: translateY(-5px) scale(1.05); 
            box-shadow: 0 15px 30px -10px rgba(10,37,64,0.4); 
        }
        
        /* TOAST */
        .toast {
            position: fixed;
            bottom: calc(2rem + var(--safe-bottom));
            left: 2rem;
            background: var(--navy);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 50px;
            box-shadow: var(--shadow-hover);
            display: flex;
            align-items: center;
            gap: 0.8rem;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 2000;
            border-left: 4px solid var(--gold);
            max-width: 90%;
        }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast i { color: var(--gold); font-size: 1.2rem; }
        
        /* LOADING */
        .loading-spinner { 
            display: inline-block; 
            width: 40px; 
            height: 40px; 
            border: 4px solid #e9eef3; 
            border-top-color: var(--gold); 
            border-radius: 50%; 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* EMPTY STATE */
        .empty-state { 
            text-align: center; 
            padding: 3rem !important; 
        }
        .empty-state i { 
            font-size: 3rem; 
            color: var(--gold); 
            margin-bottom: 1rem; 
            opacity: 0.5; 
        }
        
        /* MODAL - DENGAN NILAI */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
            padding: var(--safe-top) var(--safe-bottom) 0;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: var(--white);
            max-width: 500px;
            width: 92%;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 32px;
            padding: 1.5rem;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            position: relative;
            animation: modalPop 0.4s cubic-bezier(0.34,1.56,0.64,1);
            -webkit-overflow-scrolling: touch;
        }
        @keyframes modalPop {
            0% { opacity: 0; transform: scale(0.9) translateY(10px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }
        .close-modal {
            position: absolute;
            top: 1rem;
            right: 1.2rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--slate);
            background: #f1f5f9;
            border: none;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        .close-modal:hover { background: var(--navy); color: white; transform: rotate(90deg); }
        
        /* MODAL DETAIL NILAI - DENGAN NILAI */
        .nilai-detail-item {
            background: #f8fafc;
            border-radius: 16px;
            padding: 1rem;
            margin-bottom: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-left: 4px solid var(--gold);
        }
        .nilai-detail-item .topic {
            font-weight: 700;
            color: var(--navy);
            min-width: 80px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .nilai-detail-item .topic i {
            color: var(--gold);
            font-size: 1rem;
        }
        .nilai-detail-item .values {
            display: flex;
            gap: 0.8rem;
        }
        .nilai-detail-item .value-box {
            background: white;
            padding: 0.4rem 0.8rem;
            border-radius: 30px;
            font-weight: 700;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            min-width: 45px;
            text-align: center;
            font-size: 0.95rem;
        }
        .nilai-baik-box { background: #10b981; color: white; }
        .nilai-cukup-box { background: #f59e0b; color: white; }
        .nilai-kurang-box { background: #ef4444; color: white; }
        
        /* INFO SISWA DI MODAL */
        .siswa-info {
            background: linear-gradient(135deg, #0a2540, #1d3a5c);
            color: white;
            border-radius: 24px;
            padding: 1.2rem;
            margin-bottom: 1.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: space-around;
        }
        .siswa-info-item {
            text-align: center;
        }
        .siswa-info-label {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-bottom: 0.2rem;
        }
        .siswa-info-value {
            font-size: 1.2rem;
            font-weight: 700;
        }
        .siswa-info-value.kelas {
            background: var(--gold);
            padding: 0.2rem 1rem;
            border-radius: 30px;
            color: var(--navy);
        }
        
        /* RATA-RATA DI MODAL */
        .rata-rata-box {
            margin-top: 1.5rem;
            background: #f1f5f9;
            border-radius: 16px;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .rata-rata-label {
            font-weight: 600;
            color: var(--navy);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .rata-rata-label i {
            color: var(--gold);
        }
        .rata-rata-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gold);
        }
        
        /* RESPONSIVE */
        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .header { 
                flex-direction: column; 
                text-align: center; 
                padding: 1.2rem; 
            }
            .title { 
                font-size: 1.5rem; 
                justify-content: center; 
            }
            .title span { margin: 0.5rem 0 0; width: 100%; }
            .filter-bar { 
                flex-direction: column; 
                border-radius: 30px; 
            }
            .filter-btn, .reset-btn { width: 100%; }
            .info-card { 
                flex-direction: column; 
                gap: 1.5rem; 
                align-items: stretch; 
            }
            .info-item { justify-content: center; }
            
            /* Sticky columns di mobile */
            td:nth-child(1) { left: 0; }
            td:nth-child(2) { left: 80px; }
            td:nth-child(3) { left: 180px; }
            th:nth-child(2) { left: 80px; }
            th:nth-child(3) { left: 180px; }
            
            .nilai-detail-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            .nilai-detail-item .values {
                width: 100%;
                justify-content: space-around;
            }
        }
        
        /* PRINT */
        @media print {
            .filter-bar, .back-btn, #backToTop, .toast { display: none !important; }
            .table-container { max-height: none; overflow: visible; }
            thead { position: static; }
        }
    </style>
</head>
<body>
    <!-- TOAST -->
    <div class="toast" id="toast"><i class="fas fa-check-circle"></i><span id="toastMessage">Memuat data...</span></div>

    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <button onclick="window.history.back()" class="back-btn" aria-label="Kembali"><i class="fas fa-arrow-left"></i></button>
            <div class="title">
                <i class="fas fa-book-open"></i> Nilai Harian
                <span><i class="fas fa-calendar-alt"></i> Semester Genap 2025/2026</span>
            </div>
        </div>

        <!-- INFO CARD -->
        <div class="info-card">
            <div class="info-item">
                <div class="info-icon"><i class="fas fa-users"></i></div>
                <div class="info-text">
                    <h4>Total Siswa</h4>
                    <p id="totalData"><i class="fas fa-spinner fa-spin"></i></p>
                </div>
            </div>
            <div class="info-item">
                <div class="info-icon"><i class="fas fa-layer-group"></i></div>
                <div class="info-text">
                    <h4>Kelas</h4>
                    <p id="totalKelas"><i class="fas fa-spinner fa-spin"></i></p>
                </div>
            </div>
            <div class="info-item">
                <div class="info-icon"><i class="fas fa-chart-line"></i></div>
                <div class="info-text">
                    <h4>Rata-rata Kelas</h4>
                    <p id="rataRata"><i class="fas fa-spinner fa-spin"></i></p>
                </div>
            </div>
        </div>

        <!-- FILTER BAR -->
        <div class="filter-bar">
            <i class="fas fa-search" style="color: var(--slate);"></i>
            <input type="text" class="filter-input" id="searchNama" placeholder="Cari nama siswa...">
            <select class="filter-select" id="filterKelas">
                <option value="all">Semua Kelas</option>
                <option value="8A">Kelas 8A</option>
                <option value="9A">Kelas 9A</option>
                <option value="9B">Kelas 9B</option>
                <option value="9C">Kelas 9C</option>
                <option value="9D">Kelas 9D</option>
            </select>
            <button class="filter-btn" id="applyFilter"><i class="fas fa-filter"></i> Filter</button>
            <button class="reset-btn" id="resetFilter"><i class="fas fa-undo-alt"></i> Reset</button>
        </div>

        <!-- TABLE -->
        <div class="table-container" id="tableContainer">
            <table id="nilaiTable">
                <thead id="tableHeader"></thead>
                <tbody id="tableBody">
                    <tr><td colspan="30" class="empty-state"><div class="loading-spinner"></div><p>Memuat data nilai harian...</p></td></tr>
                </tbody>
            </table>
        </div>

        <!-- BACK TO TOP -->
        <button id="backToTop" title="Kembali ke atas"><i class="fas fa-arrow-up"></i></button>
    </div>

    <script>
        (function() {
            // ==================== KONFIGURASI ====================
            const CONFIG = {
                spreadsheetId: '1YlGB2Kiu0BOtWjRXgm7NwcQgxO6K9crzPXuevcasvjc',
                sheetName: 'Nilai_Harian',
                kelasOptions: ['8A', '9A', '9B', '9C', '9D']
            };

            // ==================== ELEMENTS ====================
            const elements = {
                toast: document.getElementById('toast'),
                toastMsg: document.getElementById('toastMessage'),
                tableHeader: document.getElementById('tableHeader'),
                tableBody: document.getElementById('tableBody'),
                totalData: document.getElementById('totalData'),
                totalKelas: document.getElementById('totalKelas'),
                rataRata: document.getElementById('rataRata'),
                searchNama: document.getElementById('searchNama'),
                filterKelas: document.getElementById('filterKelas'),
                tableContainer: document.getElementById('tableContainer'),
                backToTop: document.getElementById('backToTop')
            };

            // ==================== STATE ====================
            let originalData = [];
            let filteredData = [];
            let filterTimeout = null;

            // ==================== UTILITY ====================
            const showToast = (msg, isSuccess = true) => {
                elements.toastMsg.textContent = msg;
                elements.toast.classList.add('show');
                setTimeout(() => elements.toast.classList.remove('show'), 3000);
            };

            const parseCSV = (csvText) => {
                const lines = csvText.trim().split('\n');
                if (lines.length < 3) return [];
                
                // Skip 2 baris pertama (header), ambil data dari baris ke-3
                return lines.slice(2).map(line => {
                    // Ambil hanya 13 kolom pertama (A sampai M)
                    const allCols = line.split(',').map(cell => cell.replace(/"/g, '').trim());
                    return allCols.slice(0, 13); // Hanya kolom 0-12 (13 kolom)
                }).filter(row => row.length >= 13); // Minimal 13 kolom
            };

            // Bulatkan angka tanpa koma
            const roundNumber = (num) => {
                if (num === '-' || num === '' || num === undefined) return '-';
                const n = parseFloat(num);
                if (isNaN(n)) return '-';
                return Math.round(n).toString();
            };

            // ==================== RENDER TABLE ====================
            const renderHeader = () => {
                const topics = ['TOPIC 1', 'TOPIC 2', 'TOPIC 3'];
                
                let html = '<tr class="main-header">';
                html += `<th rowspan="2"><i class="fas fa-id-card"></i> NISN</th>`;
                html += `<th rowspan="2"><i class="fas fa-user-graduate"></i> NAMA</th>`;
                html += `<th rowspan="2"><i class="fas fa-layer-group"></i> KELAS</th>`;
                
                topics.forEach(topic => {
                    html += `<th colspan="3" class="topic-group">${topic}</th>`;
                });
                
                html += `<th rowspan="2"><i class="fas fa-chart-line"></i> RATAÂ²</th>`;
                html += '</tr>';
                
                html += '<tr class="sub-header">';
                for (let i = 0; i < 3; i++) {
                    html += `<th>R</th><th>T</th><th>E</th>`;
                }
                html += '</tr>';
                
                elements.tableHeader.innerHTML = html;
            };

            const getNilaiClass = (nilai) => {
                const num = parseInt(nilai);
                if (isNaN(num)) return '';
                if (num >= 85) return 'nilai-baik';
                if (num >= 70) return 'nilai-cukup';
                return 'nilai-kurang';
            };

            const renderTable = (data) => {
                if (!data || data.length === 0) {
                    elements.tableBody.innerHTML = `<tr><td colspan="30" class="empty-state"><i class="fas fa-users-slash"></i><p>Tidak ada data siswa</p></td></tr>`;
                    return;
                }

                const rows = data.map(row => {
                    // Pastikan row memiliki 13 kolom
                    while (row.length < 13) row.push('-');
                    
                    // Format nilai untuk setiap kolom 3-11 (9 kolom nilai untuk 3 topic)
                    let nilaiCells = '';
                    for (let i = 3; i <= 11; i++) {
                        const nilai = row[i] || '-';
                        const rounded = roundNumber(nilai);
                        const cellClass = getNilaiClass(rounded);
                        
                        if (cellClass && rounded !== '-') {
                            nilaiCells += `<td class="${cellClass}"><strong>${rounded}</strong></td>`;
                        } else {
                            nilaiCells += `<td>${rounded}</td>`;
                        }
                    }
                    
                    // Rata-rata (kolom 12)
                    const rata = row[12] || '-';
                    const rataDisplay = roundNumber(rata);
                    
                    return `<tr data-nisn="${row[0] || ''}">
                        <td>${row[0] || '-'}</td>
                        <td style="text-align: left; padding-left: 0.5rem;">${row[1] || '-'}</td>
                        <td><span class="kelas-badge">${row[2] || '-'}</span></td>
                        ${nilaiCells}
                        <td><strong>${rataDisplay}</strong></td>
                    </tr>`;
                }).join('');
                
                elements.tableBody.innerHTML = rows;
                
                // Event listener untuk baris
                document.querySelectorAll('#tableBody tr').forEach(row => {
                    row.addEventListener('click', () => {
                        const nisn = row.dataset.nisn;
                        if (nisn) showSiswaModal(nisn);
                    });
                });
            };

            // ==================== FILTER ====================
            const applyFilter = () => {
                const search = elements.searchNama.value.toLowerCase().trim();
                const kelas = elements.filterKelas.value;
                
                filteredData = originalData.filter(row => {
                    const matchNama = !search || (row[1] && row[1].toLowerCase().includes(search));
                    const matchKelas = kelas === 'all' || row[2] === kelas;
                    return matchNama && matchKelas;
                });
                
                renderTable(filteredData);
                updateInfo();
                
                if (filteredData.length !== originalData.length) {
                    showToast(`Menampilkan ${filteredData.length} dari ${originalData.length} siswa`);
                }
            };

            const resetFilter = () => {
                elements.searchNama.value = '';
                elements.filterKelas.value = 'all';
                filteredData = [...originalData];
                renderTable(filteredData);
                updateInfo();
                showToast('Filter direset');
            };

            // ==================== UPDATE INFO ====================
            const updateInfo = () => {
                const total = filteredData.length;
                elements.totalData.innerHTML = `<i class="fas fa-users"></i> ${total}`;
                
                const kelasSet = new Set();
                filteredData.forEach(row => {
                    if (row[2]) kelasSet.add(row[2]);
                });
                elements.totalKelas.innerHTML = `<i class="fas fa-layer-group"></i> ${kelasSet.size}`;
                
                // Hitung rata-rata dari kolom RATA_RATA (index 12)
                let totalNilai = 0;
                let count = 0;
                filteredData.forEach(row => {
                    const nilai = parseFloat(row[12]);
                    if (!isNaN(nilai)) {
                        totalNilai += nilai;
                        count++;
                    }
                });
                
                const avg = count > 0 ? Math.round(totalNilai / count).toString() : '-';
                elements.rataRata.innerHTML = `<i class="fas fa-star"></i> ${avg}`;
            };

            // ==================== MODAL SISWA - DENGAN NILAI ====================
            const showSiswaModal = (nisn) => {
                const siswa = filteredData.find(row => row[0] === nisn);
                if (!siswa) return;
                
                // Pastikan siswa memiliki 13 kolom
                while (siswa.length < 13) siswa.push('-');
                
                // Ambil nilai sesuai kolom:
                // Kolom 3-5: TOPIC 1 (R,T,E)
                // Kolom 6-8: TOPIC 2 (R,T,E)
                // Kolom 9-11: TOPIC 3 (R,T,E)
                // Kolom 12: RATA-RATA
                
                const topic1 = [
                    roundNumber(siswa[3]), 
                    roundNumber(siswa[4]), 
                    roundNumber(siswa[5])
                ];
                
                const topic2 = [
                    roundNumber(siswa[6]), 
                    roundNumber(siswa[7]), 
                    roundNumber(siswa[8])
                ];
                
                const topic3 = [
                    roundNumber(siswa[9]), 
                    roundNumber(siswa[10]), 
                    roundNumber(siswa[11])
                ];
                
                // Rata-rata
                const rataRata = roundNumber(siswa[12]);
                
                // Fungsi untuk mendapatkan kelas box berdasarkan nilai
                const getBoxClass = (val) => {
                    if (val === '-' || val === '') return '';
                    const num = parseInt(val);
                    if (isNaN(num)) return '';
                    if (num >= 85) return 'nilai-baik-box';
                    if (num >= 70) return 'nilai-cukup-box';
                    return 'nilai-kurang-box';
                };
                
                const modal = document.createElement('div');
                modal.className = 'modal active';
                modal.innerHTML = `
                    <div class="modal-content">
                        <button class="close-modal" onclick="this.closest('.modal').remove()"><i class="fas fa-times"></i></button>
                        
                        <h2 style="color: var(--navy); margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-user-graduate" style="color: var(--gold);"></i> ${siswa[1] || 'Detail Siswa'}
                        </h2>
                        
                        <!-- Info Siswa -->
                        <div class="siswa-info">
                            <div class="siswa-info-item">
                                <div class="siswa-info-label">NISN</div>
                                <div class="siswa-info-value">${siswa[0] || '-'}</div>
                            </div>
                            <div class="siswa-info-item">
                                <div class="siswa-info-label">Kelas</div>
                                <div class="siswa-info-value kelas">${siswa[2] || '-'}</div>
                            </div>
                        </div>
                        
                        <!-- Detail Nilai Harian -->
                        <h3 style="color: var(--navy); margin-bottom: 1rem;">
                            <i class="fas fa-book-open" style="color: var(--gold); margin-right: 0.5rem;"></i>Detail Nilai Harian
                        </h3>
                        
                        <!-- TOPIC 1 dengan nilai -->
                        <div class="nilai-detail-item">
                            <span class="topic"><i class="fas fa-book"></i> TOPIC 1</span>
                            <div class="values">
                                <span class="value-box ${getBoxClass(topic1[0])}">${topic1[0]}</span>
                                <span class="value-box ${getBoxClass(topic1[1])}">${topic1[1]}</span>
                                <span class="value-box ${getBoxClass(topic1[2])}">${topic1[2]}</span>
                            </div>
                        </div>
                        
                        <!-- TOPIC 2 dengan nilai -->
                        <div class="nilai-detail-item">
                            <span class="topic"><i class="fas fa-book"></i> TOPIC 2</span>
                            <div class="values">
                                <span class="value-box ${getBoxClass(topic2[0])}">${topic2[0]}</span>
                                <span class="value-box ${getBoxClass(topic2[1])}">${topic2[1]}</span>
                                <span class="value-box ${getBoxClass(topic2[2])}">${topic2[2]}</span>
                            </div>
                        </div>
                        
                        <!-- TOPIC 3 dengan nilai -->
                        <div class="nilai-detail-item">
                            <span class="topic"><i class="fas fa-book"></i> TOPIC 3</span>
                            <div class="values">
                                <span class="value-box ${getBoxClass(topic3[0])}">${topic3[0]}</span>
                                <span class="value-box ${getBoxClass(topic3[1])}">${topic3[1]}</span>
                                <span class="value-box ${getBoxClass(topic3[2])}">${topic3[2]}</span>
                            </div>
                        </div>
                        
                        <!-- RATA-RATA -->
                        <div class="rata-rata-box">
                            <span class="rata-rata-label">
                                <i class="fas fa-chart-line"></i> RATA-RATA
                            </span>
                            <span class="rata-rata-value">${rataRata}</span>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Close modal when clicking outside
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.remove();
                });
            };

            // ==================== FETCH DATA ====================
            const fetchData = async () => {
                const url = `https://docs.google.com/spreadsheets/d/${CONFIG.spreadsheetId}/gviz/tq?tqx=out:csv&sheet=${CONFIG.sheetName}`;
                
                try {
                    showToast('Memuat data nilai harian...');
                    const response = await fetch(url);
                    const csvText = await response.text();
                    
                    originalData = parseCSV(csvText);
                    
                    if (originalData.length === 0) {
                        elements.tableBody.innerHTML = `<tr><td colspan="30" class="empty-state"><i class="fas fa-database"></i><p>Data tidak ditemukan</p></td></tr>`;
                        return;
                    }
                    
                    filteredData = [...originalData];
                    renderHeader();
                    renderTable(filteredData);
                    updateInfo();
                    
                    showToast(`Berhasil memuat ${originalData.length} data siswa`);
                    
                } catch (error) {
                    console.error('Error fetching data:', error);
                    elements.tableBody.innerHTML = `<tr><td colspan="30" class="empty-state"><i class="fas fa-exclamation-circle"></i><p>Gagal memuat data. Periksa koneksi internet Anda.</p></td></tr>`;
                    showToast('Gagal memuat data', false);
                }
            };

            // ==================== BACK TO TOP ====================
            elements.tableContainer.addEventListener('scroll', () => {
                if (elements.tableContainer.scrollTop > 300) {
                    elements.backToTop.classList.add('show');
                } else {
                    elements.backToTop.classList.remove('show');
                }
            });
            
            elements.backToTop.addEventListener('click', () => {
                elements.tableContainer.scrollTo({ top: 0, behavior: 'smooth' });
            });

            // ==================== EVENT LISTENERS ====================
            elements.searchNama.addEventListener('input', () => {
                clearTimeout(filterTimeout);
                filterTimeout = setTimeout(applyFilter, 500);
            });
            
            elements.filterKelas.addEventListener('change', applyFilter);
            document.getElementById('applyFilter').addEventListener('click', applyFilter);
            document.getElementById('resetFilter').addEventListener('click', resetFilter);
            
            // Close modal with ESC
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal').forEach(modal => modal.remove());
                }
            });

            // Set back button
            const urlParams = new URLSearchParams(window.location.search);
            const tab = urlParams.get('tab') || 'nilai';
            document.querySelector('.back-btn').onclick = () => {
                window.location.href = `../guru/azh12345.html?tab=${tab}`;
            };

            // ==================== INIT ====================
            fetchData();
        })();
    </script>
</body>
</html>
